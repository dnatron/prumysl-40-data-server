{% extends "base.html" %}

{% block title %}{{ device.name }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item active">{{ device.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>
            {% if device.protocol == 'opcua' %}
            <span class="badge bg-info me-2">OPC UA</span>
            {% else %}
            <span class="badge bg-warning text-dark me-2">Modbus</span>
            {% endif %}
            {{ device.name }}
        </h1>
        {% if device.description %}
        <p class="text-muted mb-0">{{ device.description }}</p>
        {% endif %}
    </div>
    <div class="btn-group">
        <a href="/device/{{ device.id }}/edit" class="btn btn-secondary">
            <i class="bi bi-pencil me-1"></i>Upravit
        </a>
        <button class="btn btn-primary" 
                hx-post="/device/{{ device.id }}/poll"
                hx-target="#poll-result"
                hx-swap="innerHTML">
            <i class="bi bi-arrow-clockwise me-1"></i>Načíst nyní
        </button>
    </div>
</div>

<!-- Info karty -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Host</h5>
                <p class="display-6"><code>{{ device.host }}</code></p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Port</h5>
                <p class="display-6">{{ device.port }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Tagy</h5>
                <p class="display-6">{{ device.tags|length }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Stav</h5>
                <p class="display-6">
                    {% if device.enabled %}
                    <span class="badge bg-success fs-4">Aktivní</span>
                    {% else %}
                    <span class="badge bg-secondary fs-4">Neaktivní</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Výsledek manuálního čtení -->
<div id="poll-result"></div>

<!-- Historie měření -->
{% if measurements_data %}
<div class="card">
    <div class="card-header">
        <i class="bi bi-graph-up me-2"></i>Historie měření (posledních 100 záznamů)
    </div>
    <div class="card-body">
        <!-- Záložky pro jednotlivé tagy -->
        <ul class="nav nav-tabs" id="tagTabs" role="tablist">
            {% for data in measurements_data %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %}" 
                        id="tab-{{ data.tag.id }}" 
                        data-bs-toggle="tab" 
                        data-bs-target="#content-{{ data.tag.id }}" 
                        type="button" role="tab">
                    {{ data.tag.name }}
                    <span class="badge bg-secondary">{{ data.measurements|length }}</span>
                </button>
            </li>
            {% endfor %}
        </ul>
        
        <div class="tab-content mt-3" id="tagTabsContent">
            {% for data in measurements_data %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                 id="content-{{ data.tag.id }}" role="tabpanel">
                
                <div class="mb-3">
                    <small class="text-muted">
                        <strong>Adresa:</strong> <code>{{ data.tag.address }}</code> | 
                        <strong>Typ:</strong> {{ data.tag.data_type }} |
                        <strong>Stav:</strong> 
                        {% if data.tag.enabled %}
                        <span class="badge bg-success">Aktivní</span>
                        {% else %}
                        <span class="badge bg-secondary">Neaktivní</span>
                        {% endif %}
                    </small>
                </div>
                
                {% if data.measurements %}
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Čas</th>
                                <th>Hodnota</th>
                                <th>Kvalita</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in data.measurements %}
                            <tr>
                                <td>{{ m.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>
                                    {% if data.tag.data_type == 'bool' %}
                                        {% if m.value == 1.0 %}
                                        <span class="badge bg-success">ON</span>
                                        {% else %}
                                        <span class="badge bg-danger">OFF</span>
                                        {% endif %}
                                    {% else %}
                                        <strong>{{ "%.4f"|format(m.value) }}</strong>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if m.quality == 'good' %}
                                    <span class="text-success"><i class="bi bi-check-circle"></i> OK</span>
                                    {% else %}
                                    <span class="text-danger"><i class="bi bi-exclamation-triangle"></i> {{ m.quality }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Zatím žádná měření pro tento tag.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    Toto zařízení nemá definované žádné tagy. 
    <a href="/device/{{ device.id }}/edit" class="alert-link">Přidejte tagy</a> pro sběr dat.
</div>
{% endif %}
{% endblock %}
